<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chinese/Japanese Speaking Practice!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-size: 20px;
        font-family: "Noto Sans SC", sans-serif;
      }
      .container {
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid;
      }
      .button-container {
        margin-bottom: 20px;
        display: inline-flex;
      }
      .please-say {
        margin-top: 20px;
        font-weight: bold;
      }
      .you-said {
        margin-top: 20px;
      }
      .score {
        margin-top: 20px;
      }
      #wrong {
        color: red;
      }
      #right {
        color: green;
      }
      #judgement {
        margin-top: 20px;
      }
      .recording-container {
        margin-top: 20px;
        font-style: italic;
      }
      .recording {
        font-style: normal;
        display: inline-block;
        position: relative;
        top: -4px;
        left: 10px;
        width: 20px;
        height: 20px;
        animation: zoom-in-zoom-out 2s ease-in infinite;
      }

      @keyframes zoom-in-zoom-out {
        0% {
          transform: scale(1, 1);
        }
        50% {
          transform: scale(1.5, 1.5);
        }
        100% {
          transform: scale(1, 1);
        }
      }
    </style>
  </head>
  <body onload="init()">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>
    <script>
      function init() {
        if (!annyang) {
          document.getElementById("header").innerHTML = ""
          document.getElementsByClassName("container")[0].innerHTML =
            "Speech Recognition is not supported on this browser. Please use the newest version of Google Chrome."
          return
        }
        let phrases = {
          mandarin_deck_1_short: {},
          mandarin_deck_2_short_medium: {},
          hsk4_lesson_249: {},
          hsk1_grammar: {},
          hsk2_grammar: {},
          hsk3_grammar: {},
          hsk4_grammar: {},
          hsk5_grammar: {},
          hsk6_grammar: {},
          japanese_deck_1_short: {},
        }

        const continueButton = document.getElementById("continue")
        const againButton = document.getElementById("again")
        const playButton = document.getElementById("play")
        const resultElement = document.getElementById("result")
        const judgementElement = document.getElementById("judgement")
        const phraseElement = document.getElementById("phrase")
        const rightElement = document.getElementById("right")
        const wrongElement = document.getElementById("wrong")
        const translationElement = document.getElementById("translation")
        const showTranslationElement =
          document.getElementById("show_translation")
        const translationContainerElement = document.getElementById(
          "translation_container"
        )
        const audioElement = document.getElementById("recording")
        const deckElement = document.getElementById("decks")
        const recordingBox = document.getElementById("recording-box")

        audioElement.style.display = "none"

        let rightAnswers = 0
        let wrongAnswers = 0

        againButton.disabled = true

        let preferredLanguage = "zh-CN"

        let currentDeck, keys, randomIndex, phrase
        const synth = window.speechSynthesis
        const isMobile = navigator.userAgentData.mobile
        let mediaRecorder

        const queryString = window.location.search
        const urlParams = new URLSearchParams(queryString)

        let selectedDeck = deckElement.value
        if (urlParams.has("deck")) {
          selectedDeck = urlParams.get("deck")
          deckElement.value = selectedDeck
        }
        fetchDeck(selectedDeck).then(() => {
          currentDeck = phrases[selectedDeck]

          keys = Object.keys(currentDeck)
          randomIndex = Math.floor(Math.random() * keys.length)
          phrase = keys[randomIndex]

          phraseElement.innerText = phrase
          translationElement.innerHTML = currentDeck[phrase]
          setLanguage(selectedDeck)
          refreshCallback(phrase)
          startListening()
        })

        showTranslationElement.onchange = function () {
          if (showTranslationElement.checked) {
            translationContainerElement.style.display = "block"
          } else {
            translationContainerElement.style.display = "none"
          }
        }
        decks.onchange = function (item) {
          selectedDeck = deckElement.value
          fetchDeck(selectedDeck).then(() => {
            setLanguage(selectedDeck)
            currentDeck = phrases[selectedDeck]

            keys = Object.keys(currentDeck)
            nextPhrase()
          })
        }
        againButton.onclick = speakAgain

        function speakAgain() {
          resetUI()
          startListening()
        }

        continueButton.onclick = nextPhrase

        document.onkeydown = function (e) {
          switch (e.key) {
            case "ArrowLeft":
              speakAgain()
              break
            case "ArrowUp":
              playPhrase()
              break
            case "ArrowRight":
              nextPhrase()
              break
          }
        }

        playButton.onclick = playPhrase

        function playPhrase() {
          const utterThis = new SpeechSynthesisUtterance(phrase)
          const myLang = utterThis.lang
          utterThis.lang = preferredLanguage

          synth.speak(utterThis)
        }

        let onError = function (err) {
          console.log("The following error occured: " + err)
        }

        function onSuccess(stream) {
          let chunks = []
          mediaRecorder = new MediaRecorder(stream)
          mediaRecorder.start()

          mediaRecorder.ondataavailable = function (e) {
            chunks.push(e.data)
          }

          mediaRecorder.onstop = function (e) {
            audioElement.setAttribute("controls", "")
            audioElement.controls = true
            const blob = new Blob(chunks, { type: "audio/ogg; codecs=opus" })
            const audioURL = window.URL.createObjectURL(blob)
            audioElement.src = audioURL
            audioElement.style.display = "block"
          }
        }

        function startListening() {
          recordingBox.style.display = "block"
          annyang.start({ autoRestart: true, continuous: false })
          console.log({ isMobile })
          if (isMobile) {
            console.log("Disabling recording")
          } else {
            navigator.mediaDevices
              .getUserMedia({ audio: true })
              .then(onSuccess, onError)
          }
        }

        function stopListening() {
          recordingBox.style.display = "none"
          if (!isMobile) {
            mediaRecorder.stop()
          }
        }

        function resetUI() {
          audioElement.style.display = "none"
          resultElement.innerHTML = ""
          judgementElement.innerHTML = ""
        }

        function nextPhrase() {
          resetUI()
          randomIndex = Math.floor(Math.random() * keys.length)
          phrase = keys[randomIndex]
          phraseElement.innerText = phrase
          translationElement.innerHTML = currentDeck[phrase]
          annyang.removeCallback()
          refreshCallback(phrase)
          startListening()
        }

        async function fetchDeck(deck) {
          const res = await fetch(
            "https://benjiaming.github.io/zhongwen/" + deck + ".json"
          )
          phrases[deck] = await res.json()
        }

        function setLanguage(selectedDeck) {
          if (selectedDeck.includes("japanese")) {
            preferredLanguage = "ja-JP"
          } else if (selectedDeck.includes("czech")) {
            preferredLanguage = "cs"
          } else if (selectedDeck.includes("german")) {
            preferredLanguage = "de-DE"
          } else {
            preferredLanguage = "zh-CN"
          }
          console.log({ preferredLanguage })
          annyang.setLanguage(preferredLanguage)
        }

        function refreshCallback(expectedPhrase) {
          annyang.addCallback("result", function (actualPhrases) {
            stopListening()
            const normalizedPhrase = normalizePhrase(expectedPhrase)
            console.log({ actualPhrases, normalizedPhrase })
            if (
              actualPhrases
                .map((p) => p.toUpperCase())
                .includes(normalizedPhrase.toUpperCase())
            ) {
              markCorrect(
                expectedPhrase,
                actualPhrases.indexOf(normalizedPhrase),
                actualPhrases[0]
              )
            } else {
              markIncorrect(actualPhrases[0])
            }

            annyang.abort()
            againButton.disabled = false
          })
        }

        function normalizePhrase(phrase) {
          let normalizedPhrase = phrase.replace(/[\.,\?\!/\(\)\"\']/g, "")
          if (["zh-CN", "ja-JP"].includes(preferredLanguage)) {
            normalizedPhrase = phrase.replace(/[„ÄÇ„ÄÅÔºåÔºüÔºÅ\s+]/g, "")
          }

          return normalizedPhrase
        }

        function markCorrect(phrase, position, actualPronunciation) {
          judgementElement.style.color = "green"
          let message = "GOOD JOB! "
          if (position === 0) {
            message += "I had no problem understanding you."
          } else if (position === 1) {
            message += "Your pronunciation was a little bit off though."
          } else {
            if (preferredLanguage === "zh-CN") {
              message +=
                "You should work on your tones though. Want to try again?"
            } else {
              message += "Your pronunciation wasn't perfect though."
            }
            judgementElement.style.color = "orange"
          }
          judgementElement.innerText = message

          rightAnswers += 1
          rightElement.innerHTML = rightAnswers
          resultElement.innerHTML = actualPronunciation
          console.log(judgePronunciation(actualPronunciation, phrase))
        }

        function markIncorrect(actualPronunciation) {
          resultElement.innerHTML = actualPronunciation
          judgementElement.style.color = "red"
          judgementElement.innerText =
            "Oops. I couldn't understand you. Would you like to try again?"
          wrongAnswers += 1
          wrongElement.innerHTML = wrongAnswers
        }

        function getDifference(s, t) {
          s = [...s].sort()
          t = [...t].sort()
          return t.filter((char, i) => char !== s[i])
        }

        function judgePronunciation(
          actualPronunciation,
          expectedPronunciation
        ) {
          if (actualPronunciation === expectedPronunciation) {
            return ""
          }
          const diffs = getDifference(
            actualPronunciation,
            normalizePhrase(expectedPronunciation)
          )
          if (!diffs) {
            return expectedPronunciation
          }
          console.log({ diffs })
          return ""
        }
      }
    </script>

    <div class="container">
      <div class="child">
        <h1 id="header">Pronunciation Trainer</h1>
        <div>
          <label for="decks">Select deck: </label>
          <select name="decks" id="decks">
            <option value="mandarin_deck_1_short">
              LTL Mandarin Chinese Deck Level 1 - Short
            </option>
            <option value="mandarin_deck_2_short_medium">
              LTL Mandarin Chinese Deck Level 2 - Short Medium
            </option>
            <option value="mandarin_deck_3_medium">
              LTL Mandarin Chinese Deck Level 3 - Medium
            </option>
            <option value="mandarin_deck_4_long">
              LTL Mandarin Chinese Deck Level 4 - Medium Long
            </option>
            <option value="mandarin_deck_5_long">
              LTL Mandarin Chinese Deck Level 5 - Long
            </option>
            <option value="hsk4_lesson_249">
              HSK 4 Lesson 249: Feed on Fancies (ÊúõÊ¢ÖÊ≠¢Ê∏¥)
            </option>
            <option value="hsk1_grammar">HSK 1 Grammar Points</option>
            <option value="hsk2_grammar">HSK 2 Grammar Points</option>
            <option value="hsk3_grammar">HSK 3 Grammar Points</option>
            <option value="hsk4_grammar">HSK 4 Grammar Points</option>
            <option value="hsk5_grammar">HSK 5 Grammar Points</option>
            <option value="hsk6_grammar">HSK 6 Grammar Points</option>
            <option value="japanese_deck_1_short">
              LTL Japanese Deck Level 1 - Short
            </option>
            <option value="czech">Czech</option>
            <option value="german_b1_goethe">German B1 (Goethe)</option>
            <option value="test_deck">Test Deck</option>
          </select>
        </div>
        <div>
          <label for="show_translation">Show translations: </label>
          <input type="checkbox" id="show_translation" checked />
        </div>
        <div class="please-say">
          Please say out loud this phrase: <span id="phrase"></span>
        </div>
        <div id="translation_container">
          Translation: <span id="translation"></span>
        </div>
        <div class="recording-container" id="recording-box">
          Recording in progress... <span class="recording">üó£</span>
        </div>
        <div class="you-said">
          <div>
            This is what I heard:
            <span id="result"></span>
            <article class="clip"></article>
            <audio id="recording" controls></audio>
          </div>
        </div>
        <div id="judgement"></div>
        <div class="score">
          Score: üëç: <span id="right">0</span> üëé<span id="wrong">0</span>
        </div>
        <div class="button-container">
          <button id="again">üîÅ Try again!</button>&nbsp;
          <button id="continue">‚è≠Ô∏è Next phrase</button>&nbsp;
          <button id="play">üîà Play this phrase</button>
        </div>
      </div>
    </div>
    <p>
      <small>
        Instructions:
        <ul>
          <li>
            Select a deck to study and speak out loud the phrase displayed on
            the screen.
          </li>
          <li>
            Currently supported languages are Mandarin Chinese and Japanese.
          </li>
          <li>
            Keyboard shortcuts: ‚¨ÖÔ∏è Try again ‚¨ÜÔ∏è Play this phrase ‚û°Ô∏è Next phrase
          </li>
        </ul>

        Disclaimer:
        <ul>
          <li>
            This tool only works on Google Chrome (desktop and mobile) and Edge.
          </li>
          <li>
            The text to speech and the speech recognition engines are not
            perfect - especially as the phrase gets more complex.
          </li>
          <li>
            Just because you get thumbs up doesn‚Äôt mean your pronunciation is
            perfect (since speech recognition is meant to be forgiving).
          </li>
          <li>A perfect pronunciation doesn‚Äôt guarantee you get thumbs up.</li>
          <li>
            Some of the decks contain a mixture of simplified and traditional
            characters. This confuses the speech recognition engine so you may
            not be able to get thumbs up even with a perfect pronunciation.
          </li>
        </ul>
        Sources:
        <ul>
          <li>
            <a href="https://flexiclasses.com/anki-decks-chinese/"
              >https://flexiclasses.com/anki-decks-chinese/</a
            >
          </li>
          <li>
            <a href="https://www.zerotohero.ca/en/zh/grammar"
              >https://www.zerotohero.ca/en/zh/grammar</a
            >
          </li>
        </ul>
      </small>
    </p>
  </body>
</html>
