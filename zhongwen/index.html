<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chinese/Japanese Speaking Practice!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-size: 20px;
        font-family: "Noto Sans SC", sans-serif;
      }
      .container {
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid;
      }
      .button-container {
        display: inline-flex;
      }
      .please-say {
        margin-top: 20px;
        font-weight: bold;
      }
      .you-said {
        margin-top: 20px;
      }
      .score {
        margin-top: 20px;
      }
      #wrong {
        color: red;
      }
      #right {
        color: green;
      }
    </style>
  </head>
  <body onload="init()">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>
    <script>
      function init() {
        if (!annyang) {
          document.getElementById("header").innerHTML = ""
          document.getElementsByClassName("container")[0].innerHTML =
            "Speech Recognition is not supported on this browser. Please use the newest version of Google Chrome."
          return
        }
        let phrases = {
          mandarin_deck_1_short: {},
          mandarin_deck_2_short_medium: {},
          hsk4_lesson_249: {},
          hsk2_grammar: {},
          hsk3_grammar: {},
          hsk4_grammar: {},
          hsk5_grammar: {},
          japanese_deck_1_short: {},
        }

        const continueButton = document.getElementById("continue")
        const againButton = document.getElementById("again")
        const resultElement = document.getElementById("result")
        const judgementElement = document.getElementById("judgement")
        const phraseElement = document.getElementById("phrase")
        const rightElement = document.getElementById("right")
        const wrongElement = document.getElementById("wrong")
        const translationElement = document.getElementById("translation")
        const showTranslationElement =
          document.getElementById("show_translation")
        const translationContainerElement = document.getElementById(
          "translation_container"
        )

        let rightAnswers = 0
        let wrongAnswers = 0

        againButton.disabled = true

        let currentDeck, keys, randomIndex, phrase

        let selectedDeck = document.getElementById("decks").value
        fetchDeck(selectedDeck).then(() => {
          currentDeck = phrases[selectedDeck]

          keys = Object.keys(currentDeck)
          randomIndex = Math.floor(Math.random() * keys.length)
          phrase = keys[randomIndex]

          phraseElement.innerText = phrase
          translationElement.innerHTML = currentDeck[phrase]
        })

        showTranslationElement.onchange = function () {
          if (showTranslationElement.checked) {
            translationContainerElement.style.display = "block"
          } else {
            translationContainerElement.style.display = "none"
          }
        }
        decks.onchange = function (item) {
          selectedDeck = document.getElementById("decks").value
          fetchDeck(selectedDeck).then(() => {
            setLanguage(selectedDeck)
            currentDeck = phrases[selectedDeck]

            keys = Object.keys(currentDeck)
            nextPhrase()
          })
        }
        againButton.onclick = function () {
          resultElement.innerHTML = ""
          judgementElement.innerHTML = ""
          annyang.start({ autoRestart: true, continuous: false })
        }

        continueButton.onclick = nextPhrase

        function nextPhrase() {
          randomIndex = Math.floor(Math.random() * keys.length)
          phrase = keys[randomIndex]
          phraseElement.innerText = phrase
          translationElement.innerHTML = currentDeck[phrase]
          annyang.removeCallback()
          refreshCallback(phrase)
          resultElement.innerHTML = ""
          judgementElement.innerHTML = ""
          annyang.start({ autoRestart: true, continuous: false })
        }

        setLanguage(selectedDeck)
        refreshCallback(phrase)

        async function fetchDeck(deck) {
          const res = await fetch(
            "https://benjiaming.github.io/zhongwen/" + deck + ".json"
          )
          phrases[deck] = await res.json()
        }

        function setLanguage(selectedDeck) {
          if (selectedDeck.includes("japanese")) {
            annyang.setLanguage("ja")
          } else if (selectedDeck.includes("vietnamese")) {
            annyang.setLanguage("zh-CN")
          } else {
            annyang.setLanguage("zh-CN")
          }
        }
        function refreshCallback(phrase) {
          annyang.addCallback("result", function (phrases) {
            if (phrases.includes(phrase)) {
              markCorrect(phrase)
            } else {
              if (phrases.includes(phrase.replace("Ôºü", ""))) {
                markCorrect(phrase)
              } else if (phrases.includes(phrase.replace("ÔºÅ", ""))) {
                markCorrect(phrase)
              } else if (phrases.includes(phrase.replace("„ÄÇ", ""))) {
                markCorrect(phrase)
              } else {
                markIncorrect(phrases[0])
              }
            }
            annyang.abort()
            againButton.disabled = false
          })
        }

        annyang.start({ autoRestart: true, continuous: false })

        function markCorrect(phrase) {
          resultElement.innerText = phrase
          resultElement.style.color = "green"
          judgementElement.innerText = "GOOD JOB!"
          rightAnswers += 1
          rightElement.innerHTML = rightAnswers
        }

        function markIncorrect(phrase) {
          resultElement.innerText = phrase
          resultElement.style.color = "red"
          judgementElement.innerText = "Oops. Try again!"
          wrongAnswers += 1
          wrongElement.innerHTML = wrongAnswers
        }
      }
    </script>

    <h1 id="header">Repeat the phrase you see below</h1>
    <div class="container">
      <div class="child">
        <div>
          <label for="decks">Select deck: </label>
          <select name="decks" id="decks">
            <option value="mandarin_deck_1_short">
              LTL Mandarin Chinese Deck Level 1 - Short
            </option>
            <option value="mandarin_deck_2_short_medium">
              LTL Mandarin Chinese Deck Level 2 - Short Medium
            </option>
            <option value="hsk4_lesson_249">
              HSK 4 Lesson 249: Feed on Fancies (ÊúõÊ¢ÖÊ≠¢Ê∏¥)
            </option>
            <option value="hsk3_grammar">HSK 3 Grammar Points</option>
            <option value="hsk4_grammar">HSK 4 Grammar Points</option>
            <option value="hsk5_grammar">HSK 5 Grammar Points</option>
            <option value="japanese_deck_1_short">
              LTL Japanese Deck Level 1 - Short
            </option>
          </select>
        </div>
        <div>
          <label for="show_translation">Show translations: </label>
          <input type="checkbox" id="show_translation" checked />
        </div>
        <div class="please-say">Please say: <span id="phrase"></span></div>
        <div id="translation_container">
          Translation: <span id="translation"></span>
        </div>
        <div class="you-said">You said: <span id="result"></span></div>
        <div id="judgement"></div>
        <div class="score">
          Score: üëç: <span id="right">0</span> üëé<span id="wrong">0</span>
        </div>
        <div class="button-container">
          <button id="again">Try again!</button>&nbsp;
          <button id="continue">Next word</button>
        </div>
      </div>
    </div>
    <p>
      <small>
        Sources:
        <ul>
          <li>
            <a href="https://flexiclasses.com/anki-decks-chinese/"
              >https://flexiclasses.com/anki-decks-chinese/</a
            >
          </li>
          <li>
            <a href="https://www.zerotohero.ca/en/zh/grammar"
              >https://www.zerotohero.ca/en/zh/grammar</a
            >
          </li>
        </ul>
      </small>
    </p>
  </body>
</html>
